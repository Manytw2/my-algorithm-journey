# C++ç®—æ³•ç»ƒä¹ ç¯å¢ƒ - ç°ä»£åŒ–CMakeé…ç½®
# æ”¯æŒå¤šæ–‡ä»¶ç‹¬ç«‹è¿è¡Œã€é«˜ç²¾åº¦æ€§èƒ½æµ‹é‡ã€ä¼˜é›…çš„å·¥å…·å‡½æ•°å¤ç”¨

cmake_minimum_required(VERSION 3.16)
project(AlgorithmLearning VERSION 1.0.0 LANGUAGES CXX)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹
if(MSVC)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /W4 /permissive-")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /O2 /DNDEBUG")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} /Od /Zi")
else()
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3 -DNDEBUG")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -O0 -g")
endif()

# è®¾ç½®è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# åŒ…å«å¤´æ–‡ä»¶ç›®å½•
include_directories(${CMAKE_SOURCE_DIR}/include)

# è‡ªåŠ¨å‘ç°ç®—æ³•æ–‡ä»¶
file(GLOB_RECURSE ALGORITHM_SOURCES 
    "algorithms/*.cpp"
    "QuickSort/*.cpp"
)

# è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ–‡ä»¶
list(FILTER ALGORITHM_SOURCES EXCLUDE REGEX ".*/output/.*")
list(FILTER ALGORITHM_SOURCES EXCLUDE REGEX ".*algorithm_runner.*")

# ä¸ºæ¯ä¸ªç®—æ³•æ–‡ä»¶åˆ›å»ºç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶
foreach(SOURCE_FILE ${ALGORITHM_SOURCES})
    # è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„å’Œæ‰©å±•åï¼‰
    get_filename_component(FILE_NAME ${SOURCE_FILE} NAME_WE)
    
    # è·³è¿‡é‡å¤çš„æ–‡ä»¶åï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if(TARGET ${FILE_NAME})
        continue()
    endif()
    
    # åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
    add_executable(${FILE_NAME} ${SOURCE_FILE})
    
    # è®¾ç½®è¾“å‡ºç›®å½•
    set_target_properties(${FILE_NAME} PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}
    )
    
    # æ·»åŠ ç¼–è¯‘å®šä¹‰
    target_compile_definitions(${FILE_NAME} PRIVATE
        $<$<CONFIG:Debug>:DEBUG>
        $<$<CONFIG:Release>:NDEBUG>
    )
    
    message(STATUS "âœ… å‘ç°ç®—æ³•æ–‡ä»¶: ${SOURCE_FILE} -> ${FILE_NAME}")
endforeach()

# åˆ›å»ºç®—æ³•ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
file(MAKE_DIRECTORY ${CMAKE_SOURCE_DIR}/algorithms/sorting)
file(MAKE_DIRECTORY ${CMAKE_SOURCE_DIR}/algorithms/searching)
file(MAKE_DIRECTORY ${CMAKE_SOURCE_DIR}/algorithms/graph)
file(MAKE_DIRECTORY ${CMAKE_SOURCE_DIR}/algorithms/dp)

# åˆ›å»ºç¤ºä¾‹ç®—æ³•æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
set(EXAMPLE_ALGORITHMS
    "algorithms/sorting/bubble_sort.cpp"
    "algorithms/sorting/selection_sort.cpp"
    "algorithms/sorting/insertion_sort.cpp"
    "algorithms/searching/binary_search.cpp"
    "algorithms/searching/linear_search.cpp"
)

foreach(EXAMPLE_FILE ${EXAMPLE_ALGORITHMS})
    if(NOT EXISTS ${CMAKE_SOURCE_DIR}/${EXAMPLE_FILE})
        message(STATUS "ğŸ“ å°†åˆ›å»ºç¤ºä¾‹æ–‡ä»¶: ${EXAMPLE_FILE}")
    endif()
endforeach()

# æ‰“å°æ„å»ºä¿¡æ¯
message(STATUS "")
message(STATUS "ğŸ¯ ====== æ„å»ºé…ç½®å®Œæˆ ======")
message(STATUS "ğŸ“ é¡¹ç›®åç§°: ${PROJECT_NAME} v${PROJECT_VERSION}")
message(STATUS "ğŸ”§ C++æ ‡å‡†: C++${CMAKE_CXX_STANDARD}")
message(STATUS "ğŸ“Š å‘ç°ç®—æ³•æ–‡ä»¶æ•°é‡: ${CMAKE_CURRENT_LIST_LENGTH}")
message(STATUS "ğŸ“‚ å¯æ‰§è¡Œæ–‡ä»¶è¾“å‡ºç›®å½•: ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
message(STATUS "ğŸ“‹ åŒ…å«ç›®å½•: ${CMAKE_SOURCE_DIR}/include")
message(STATUS "ğŸ¯ ================================")
message(STATUS "")

# æ·»åŠ è‡ªå®šä¹‰ç›®æ ‡
add_custom_target(list_algorithms
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸ“‹ å¯ç”¨ç®—æ³•åˆ—è¡¨:"
    COMMAND ${CMAKE_COMMAND} -E echo "=================="
    COMMAND ${CMAKE_COMMAND} -E echo "QuickSortç®—æ³•:"
    COMMAND ${CMAKE_COMMAND} -E echo "  - Code01_Partition1"
    COMMAND ${CMAKE_COMMAND} -E echo "  - Code02_Partition2" 
    COMMAND ${CMAKE_COMMAND} -E echo "  - Code03_QuickSort"
    COMMAND ${CMAKE_COMMAND} -E echo ""
    COMMAND ${CMAKE_COMMAND} -E echo "å…¶ä»–ç®—æ³•:"
    COMMAND ${CMAKE_COMMAND} -E echo "  - æŸ¥çœ‹ algorithms/ ç›®å½•"
    COMMAND ${CMAKE_COMMAND} -E echo ""
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸ’¡ ä½¿ç”¨æ–¹æ³•:"
    COMMAND ${CMAKE_COMMAND} -E echo "  cmake --build . --target <ç®—æ³•åç§°>"
    COMMAND ${CMAKE_COMMAND} -E echo "  ./bin/<ç®—æ³•åç§°>"
    VERBATIM
)

# æ·»åŠ æ¸…ç†ç›®æ ‡
add_custom_target(clean_all
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_BINARY_DIR}/bin
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_BINARY_DIR}/lib
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸ§¹ æ¸…ç†å®Œæˆ"
    VERBATIM
)

# å®‰è£…è§„åˆ™
install(TARGETS ${ALGORITHM_SOURCES}
    RUNTIME DESTINATION bin
)

install(FILES include/utility.h
    DESTINATION include
)